<p align="center">
  <img src="assets/icon.png" alt="WoWTranslator" width="80" />
</p>

<h1 align="center">WoW Chat Translator</h1>

<p align="center">
  <b>Переводчик чата World of Warcraft в реальном времени со смарт-оверлеем</b><br>
  Приложение-компаньон + мини-аддон для мультиязычных групп
</p>

<p align="center">
  <a href="LICENSE"><img src="https://img.shields.io/badge/License-Apache_2.0-blue.svg" alt="License" /></a>
  <a href="https://python.org"><img src="https://img.shields.io/badge/Python-3.12+-yellow.svg" alt="Python" /></a>
  <a href="https://github.com/Yumash/WoWTranslator/releases"><img src="https://img.shields.io/github/v/release/Yumash/WoWTranslator" alt="Release" /></a>
</p>

<p align="center">
  <a href="README.en.md">English version</a>
</p>

---

## Что это?

WoWTranslator — десктопное приложение-компаньон, которое переводит чат World of Warcraft **в реальном времени** — с задержкой менее 1 секунды. Мини-аддон для WoW перехватывает сообщения чата и записывает их в буфер памяти; приложение-компаньон читает этот буфер, определяет язык, переводит через DeepL и показывает результат в стильном оверлее поверх игры.

Никаких языковых барьеров в PUG-группах, международных гильдиях и кроссерверных рейдах.

## Ключевые возможности

- **Перевод в реальном времени** — сообщения появляются в оверлее в течение ~1 секунды
- **Автоопределение языка** — на базе lingua-py, полностью офлайн (~1мс на сообщение)
- **Умный оверлей** — тёмная тема в стиле WoW с цветами каналов, прозрачный для кликов
- **Двусторонний перевод** — переводит входящий чат И позволяет писать ответы на любом языке
- **Встроенный разговорник** — 45 фраз + 30 игровых аббревиатур переводятся мгновенно без API
- **Фильтры каналов** — Группа, Рейд, Гильдия, Сказать/Крик, Шёпот, Подземелье — выбирай нужное
- **DeepL Free API** — 500 000 символов в месяц бесплатно (это ОЧЕНЬ много чата)
- **Кэш переводов** — SQLite + LRU в памяти, одно и то же никогда не переводится дважды
- **Глобальные горячие клавиши** — переключай перевод, не выходя из игры
- **Мастер настройки** — пошаговая первоначальная настройка за 5 шагов
- **Системный трей** — свернуть в трей, быстрый доступ к настройкам
- **22 языка** — EN, RU, DE, FR, ES, IT, PT, PL, NL, SV, DA, FI, CS, RO, HU, BG, EL, TR, UK, JA, KO, ZH

## Как это работает

### Проблема

WoW пишет чат в `WoWChatLog.txt`, но использует внутренний буфер ~4KB. Файл обновляется только когда буфер заполняется — **реальная задержка 1-5 минут**. Для переводчика чата это неприемлемо.

### Решение

Мини-аддон перехватывает события чата через стандартное WoW API и записывает сообщения в Lua-строку с уникальными маркерами. Приложение-компаньон находит эту строку в памяти процесса WoW через `ReadProcessMemory` и доставляет сообщения в пайплайн перевода — всё за ~1 секунду.

```
┌──────────────────────────────────────────────────────────┐
│  World of Warcraft                                       │
│                                                          │
│  Аддон ChatTranslatorHelper                              │
│  ├── Перехватывает события CHAT_MSG_*                    │
│  ├── Опрашивает ChatFrame scrollback (200мс)             │
│  ├── Кольцевой буфер (50 сообщений)                     │
│  │   Формат: SEQ|RAW|форматированный текст               │
│  └── Пишет в ChatTranslatorHelperDB.wctbuf               │
│      с маркерами __WCT_BUF__ / __WCT_END__               │
└──────────┬───────────────────────────────────────────────┘
           │  ReadProcessMemory (каждые 500мс)
           ▼
┌──────────────────────────────────────────────────────────┐
│  Приложение-компаньон (Python, запуск от админа)         │
│                                                          │
│  Memory Reader ──→ Парсер ──→ Детектор языка             │
│       │                           │                      │
│       │         ┌─────────────────┘                      │
│       │         ▼                                        │
│       │    Разговорник (мгновенно) ──→ Кэш (SQLite)     │
│       │         │                         │              │
│       │         ▼                         ▼              │
│       │    DeepL API ──────────→ Смарт-оверлей (PyQt6)  │
│       │                                                  │
│  File Watcher (фоллбэк, опрос каждую 1с)                │
└──────────────────────────────────────────────────────────┘
```

### Пайплайн перевода

Каждое сообщение проходит через многоступенчатый пайплайн:

1. **Проверка аббревиатур** (до детекции) — `gg` → `хорошая игра`, `ty` → `спасибо` — мгновенно
2. **Определение языка** — lingua-py определяет язык офлайн, кириллический фоллбэк для коротких текстов
3. **Поиск фраз** (после детекции) — `hello` → `привет`, `danke` → `спасибо` — мгновенно
4. **Поиск в кэше** — персистентный кэш SQLite + LRU в памяти (1000 записей)
5. **DeepL API** — вызывается только когда всё выше промахнулось

Сообщения на вашем языке никогда не переводятся. Игровой жаргон (`lol`, `afk`, `brb`, `pull` и т.д.) автоматически пропускается.

### Смарт-оверлей

Оверлей стилизован под нативный чат WoW — тёмный полупрозрачный фон с правильными цветами каналов:

| Канал | Цвет |
|-------|------|
| Сказать | Белый |
| Крик | Красный |
| Группа | Голубой |
| Рейд | Оранжевый |
| Гильдия | Зелёный |
| Шёпот | Розовый |
| Подземелье | Оранжевый |

Возможности:
- **Прозрачный для кликов** по умолчанию — клики проходят в игру
- **Перетаскивание и изменение размера** — позиция и размер запоминаются
- **Свёртка до заголовка** — минимизируй одним кликом
- **Вкладки фильтров каналов** — показывай только нужные каналы
- **Панель ответов** — набери сообщение, выбери язык, нажми Enter, скопируй перевод в буфер обмена

### Архитектура Memory Reader

Memory reader использует каскадную стратегию сканирования для максимальной скорости:

| Уровень | Скорость | Когда используется |
|---------|----------|-------------------|
| History scan (16 кэшированных регионов) | ~30мс | Первая попытка — проверяет регионы, где маркер был найден ранее |
| Heap scan (все регионы ≤ 8MB) | ~1-3с | Промах истории — сканирует все heap-регионы |
| Full scan (весь процесс) | ~7-10с | Крайний случай — полный скан через pymem |

Аддон создаёт новую Lua-строку при каждом обновлении буфера (строки в Lua иммутабельны). Memory reader отслеживает, в каких регионах памяти ранее находился маркер, и проверяет их первыми — что даёт субсекундное нахождение после перемещения буфера.

## Установка

### Быстрый старт (рекомендуется)

1. Скачай `WoWTranslator.zip` из [Releases](https://github.com/Yumash/WoWTranslator/releases)
2. Распакуй и запусти `WoWTranslator.exe` **от имени Администратора**
3. Следуй мастеру настройки:
   - Получи [бесплатный API-ключ DeepL](https://www.deepl.com/pro-api) (занимает 2 минуты)
   - Укажи путь к установке WoW (автоопределение в большинстве случаев)
   - Выбери свой язык и целевой язык перевода
   - Установи аддон одним кликом
4. Запусти WoW, зайди в группу и смотри как появляются переводы!

### Из исходников

```bash
git clone https://github.com/Yumash/WoWTranslator.git
cd WoWTranslator
pip install -r requirements.txt
python -m app.main
```

> **Важно:** Запускать от имени Администратора (ReadProcessMemory требует повышенных привилегий).

### Аддон WoW (ручная установка)

Скопируй папку `addon/ChatTranslatorHelper/` в:
```
World of Warcraft/_retail_/Interface/AddOns/ChatTranslatorHelper/
```

Или позволь приложению-компаньону установить его (Настройки → Установить аддон).

## Настройка

### Мастер настройки

При первом запуске пошаговый мастер проведёт через 5 шагов:

1. **Приветствие** — выбор языка интерфейса
2. **API-ключ** — вставь ключ DeepL и проверь его валидность
3. **Путь к WoW** — автоопределение или ручной выбор
4. **Языки** — свой язык и целевой язык перевода
5. **Готово** — установка аддона и запуск

### Диалог настроек

Доступен через кнопку на панели оверлея или системный трей → Настройки.

**Вкладка «Основные»:**
- Управление API-ключом DeepL с отображением квоты использования
- Путь к WoW и установщик аддона
- Язык интерфейса (RU, EN)
- Ваш язык / целевой язык перевода
- Переключатели каналов (Группа, Рейд, Гильдия, Сказать/Крик, Шёпот, Подземелье)

**Вкладка «Оверлей»:**
- Прозрачность фона (20-100%)
- Размер шрифта (8-20pt)
- Перевод ВКЛ по умолчанию
- Показывать окно отладки (консоль)

**Вкладка «Горячие клавиши»:**
- Переключение перевода (по умолчанию: `Ctrl+Shift+T`)
- Перевод из буфера обмена (по умолчанию: `Ctrl+Shift+C`)
- Захват комбинации клавиш с поддержкой модификаторов

### Команды аддона

Введи в чат WoW:

| Команда | Описание |
|---------|----------|
| `/wct` | Статус аддона |
| `/wct buf` | Информация о буфере памяти (кол-во сообщений, seq) |
| `/wct log on\|off` | Включить/выключить логирование чата |
| `/wct auto on\|off` | Авто-логирование при входе |
| `/wct flush on\|off\|<сек>` | Управление таймером flush |
| `/wct poll on\|off` | Управление опросом ChatFrame |
| `/wct verbose on\|off` | Подробные сообщения |

### config.json

Все настройки хранятся в `config.json` (создаётся автоматически). Основные поля:

```json
{
  "deepl_api_key": "ваш-ключ:fx",
  "wow_path": "D:/World of Warcraft",
  "own_language": "RU",
  "target_language": "EN",
  "overlay_opacity": 180,
  "overlay_font_size": 10,
  "hotkey_toggle_translate": "Ctrl+Shift+T",
  "channels_party": true,
  "channels_raid": true,
  "channels_guild": true,
  "channels_say": true,
  "channels_whisper": true,
  "channels_instance": true,
  "show_debug_console": false
}
```

## Встроенный разговорник

WoWTranslator включает встроенный разговорник для мгновенного перевода популярных фраз и игровых аббревиатур — **без обращения к API**.

**45 фраз** на 5 языках (EN, RU, DE, FR, ES):
- Приветствия: hello, bye, good morning, welcome, see you...
- Вежливость: thanks, please, sorry, no problem, my bad...
- Координация: ready, wait, follow me, on my way, need help...
- WoW-специфичные: summon please, invite please, good run, well played...

**30 игровых аббревиатур** (универсальные):
`gg`, `bb`, `afk`, `brb`, `ty`, `np`, `wp`, `gj`, `gl`, `hf`, `omw`, `oom`, `lfg`, `lfm`, `inv`, `rdy`, `inc`, `wts`, `wtb`, `mb`, `idd`, `lf`, `pls`, `thx`, `nvm`, `idk`, `imo`, `tbh`, `btw`, `gtg`

## Стек технологий

| Компонент | Технология |
|-----------|-----------|
| Приложение-компаньон | Python 3.12 |
| GUI / Оверлей | PyQt6 (WS_EX_TRANSPARENT, click-through) |
| Memory Reader | pymem (ReadProcessMemory) |
| Определение языка | lingua-py (офлайн, ~1мс) |
| Перевод | DeepL Free API (500K символов/мес) |
| Разговорник | Встроенный: 45 фраз + 30 аббревиатур |
| Кэш | SQLite + LRU в памяти |
| Сборка | PyInstaller → single .exe |
| Аддон WoW | Lua 5.1 (~300 строк) |
| Версия WoW | The War Within / Midnight (12.0+) |

## Соответствие ToS Blizzard

| Аспект | Статус |
|--------|--------|
| Чтение памяти (ReadProcessMemory) | Только чтение. Warden не флагит read-only доступ. Тот же подход что у WeakAuras Companion и WarcraftLogs. |
| Оверлей поверх игры | Разрешено. Тот же подход что у Discord Overlay. |
| Аддон хукает CHAT_MSG_* | Стандартное WoW API. Используется всеми чат-аддонами. |
| Нет инъекции кода | Соответствует. Нет DLL-инъекции, нет хуков. |
| Нет автоматизации | Соответствует. Нет автоматических действий, движения, боя. |
| Отправка через буфер обмена | Пользователь вручную вставляет через Ctrl+V. Не автоматизация. |

## Ограничения

- **Требуются права Администратора** — ReadProcessMemory нужны повышенные привилегии
- **DeepL Free** — 500K символов/мес (~10K сообщений). Для безлимита — платный план.
- **Lua-песочница WoW** — аддон не может делать HTTP-запросы, поэтому перевод только через компаньон
- **Отправка сообщений** — вручную (копировать → вставить → Enter в WoW). Так задумано для соответствия ToS.
- **Нумерованные каналы** — Торговля, Общий, Поиск группы пока не парсятся (низкий приоритет)
- **Только Windows** — ReadProcessMemory — Windows API

## Разработка

```bash
# Запуск
python -m app.main

# Тесты
pytest

# Линтер
ruff check app/ tests/

# Сборка .exe
pyinstaller build.spec
```

## Авторы

- **Andrey Yumashev** — [@Yumash](https://github.com/Yumash)
- **Claude** (Anthropic) — AI-соавтор

## Поддержать проект

Если WoWTranslator делает ваш мультиязычный опыт в WoW лучше, поддержите разработку:

| Криптовалюта | Адрес |
|---|---|
| **USDT TRC20 (ByBit)** | `TGaUz963ZaCoHrfoDDgy1sCvSrK1wsZvcx` |
| **BTC (ByBit)** | `1BkYvFT8iBVG3GfTqkR2aBkABNkTrhYuja` |
| **TON** | `UQDFaHBN1pcQZ7_9-w1E_hS_JNfGf3d0flS_467w7LOQ7xbK` |

## Лицензия

[Apache License 2.0](LICENSE)
